# API Reference â€” Backend (services & models)

This document is a concise reference for the core service classes and
models implemented in `backend/app`.

## Services

- `app.services.execution.RAExecutor`
  - Purpose: parse and execute relational-algebra scripts using the bundled
    `radb` engine.
  - Key methods:
    - `RAExecutor(db_path='bank.db')`: constructor; `db_path` may be a
      filesystem `.db` path or a SQLAlchemy URL.
    - `execute(raw_query) -> (output: str, error: Optional[str])`: run an
      RA script and return captured stdout and an optional error string.
  - Notes: performs small frontend cleanup (LaTeX artifacts) and creates a
    fresh `radb` context for each execution to avoid shared state.

- `app.services.grading.grade_submission(submission)`
  - Purpose: grade a `Submission` instance by running the question's
    `solution_query` and the student's `student_query` across defined
    `QuestionTestCase` DB fixtures and awarding milestone partial credit.
  - Behavior:
    - Uses `RAExecutor` to run queries for each testcase.
    - Compares outputs (currently textual stripped-equality) and sums
      weights/points to compute the earned score.
    - Persists `submission.score_earned`, `submission.grading_feedback`, and
      `submission.last_updated`.

- `app.services.grading_engine.GradingEngine`
  - Purpose: deprecated shim that delegates to `grade_submission`.

- `app.services.permissions.can_manage_course(user, course)`
  - Purpose: small helper used by views to determine whether `user` can
    administrate `course` (checks role name for `instructor`/`admin`).

## Models

All models live under `app.models` and are SQLAlchemy models via
`app.extensions.db`.

- `User`
  - Fields: `id`, `email`, `name`, `avatar_url`, `is_platform_admin`, `created_at`.
  - Relations: `memberships -> CourseMembership`.

- `CourseMembership`
  - Purpose: association object linking `User` and `Course` with a `role`.

- `Course`
  - Fields: `id`, `title`, `term`, `description`, `is_published`, `created_at`.
  - Relations: `members`, `assessments`.

- `Assessment`
  - Purpose: collection of `Question` objects representing an assignment/quiz.
  - Fields: scheduling and configuration fields (opens_at, closes_at, exam_mode, etc.).
  - Relations: `questions`, `attempts`.

- `Question`
  - Fields: `id`, `assessment_id`, `prompt`, `points`, `solution_query`, etc.
  - Relations: `test_cases`, `milestones`.

- `QuestionTestCase`
  - Purpose: a single testcase referencing a `db_path` fixture and a weight.

- `QuestionMilestone`
  - Purpose: a check_query that awards partial points when satisfied.

- `Attempt`
  - Purpose: groups submissions for a student's attempt at an assessment.

- `Submission`
  - Purpose: stores a student's `student_query` for a `Question` plus
    grading results (`score_earned`, `grading_feedback`).

## Notes & Recommendations

- Type checking: running `mypy` with lenient flags produced errors
  originating from SQLAlchemy dynamic model bases (e.g., `db.Model` not
  recognized). To improve mypy output, consider adding a small typing
  annotation in `app/extensions.py` (for example `from typing import Any;
  db: Any = SQLAlchemy()`), or add a `mypy.ini` to tune `ignore_missing_imports` and
  per-module ignores.

- Linting: `flake8` was run and project-level warnings were fixed; the
  vendor `radb` directory remains excluded from linting.

- Future docs: I can convert this reference into autogenerated Markdown
  (parsing AST or using docstring extraction) if you want a machine
  generated API reference.
